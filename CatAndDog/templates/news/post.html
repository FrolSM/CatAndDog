{% extends 'flatpages/default.html' %}
{% load news_filters %}

{% block title %}{{ post.title }}{% endblock %}
{% block content %}
    <div class="postdeteil">
        <h1>{{ post.title }}</h1>
        <p>Категория: {{ post.category }} Пользователь: {{ post.author }}<br> Дата: {{ post.time }}</p>
        {% if post.photo %}
            <img class="img-article-left" src="{{ post.photo.url }}">
        {% endif %}
        {% if post.video %}
            <video class="video" controls src="{{ post.video.url }}"></video>
        {% endif %}
        <h5>{{ post.text|censor }}</h5>
        <div class="like">
            <a href="{% url 'post_comment' post.pk %}"> Комментировать <i class="fa-regular fa-comment"></i></a>
        </div>
        <br>
        <div class="post" data-post-id="{{ post.id }}">
            <button class="like-btn" data-post-id="{{ post.id }}">
                {% if request.user in post.liked_users %}
                    Unlike
                {% else %}
                    Like
                {% endif %}
            </button>

            <span class="like-count" data-post-id="{{ post.id }}">
                {{ post.like_count }}
            </span>
        </div>

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
        $(document).ready(function() {
            $('.like-btn').click(function() {
                var postId = $(this).data('post-id');
                $.ajax({
                    url: `/post/${postId}/like/`,
                    type: 'POST',
                    headers: {'X-CSRFToken': '{{ csrf_token }}'},
                    success: function(response) {
                        // Обновляем текст кнопки
                        $(`.like-btn[data-post-id="${postId}"]`).text(
                            response.liked ? 'Unlike' : 'Like'
                        );
                        // Обновляем счётчик
                        $(`.like-count[data-post-id="${postId}"]`).text(response.count);
                    }
                });
            });
        });
        </script>
        <br>
        <div class="comment">
            <h3>Комментарии:</h3>
            {% for comment in post.comment_set.all %}
            <p> Автор комментария: "{{ comment.user }}" Время: {{ post.time }}</p>
            <h5> {{ comment.text }}</h5>
            {% if not forloop.last %}
                <hr>
            {% endif %}
            {% endfor %}
        </div>
    </div>
{% endblock content %}